<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatiÃ¨re - LearnHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="dashboard-eleve.html" class="text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center">
                            <span id="matiereIcon" class="text-2xl">ðŸ“š</span>
                        </div>
                        <div>
                            <h1 id="matiereTitle" class="text-lg font-bold text-gray-900">Chargement...</h1>
                            <p class="text-xs text-gray-500">SÃ©lectionne un chapitre</p>
                        </div>
                    </div>
                </div>
                <a href="dashboard-eleve.html" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">
                    Retour
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- SÃ©lection de classe -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3">Filtre par niveau</label>
            <select id="classeFilter" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                <option value="">Tous les niveaux</option>
            </select>
        </div>

        <!-- Liste des chapitres -->
        <div id="chapitresContainer" class="space-y-4">
            <!-- Loading -->
            <div class="animate-pulse space-y-4">
                <div class="bg-white rounded-xl p-6 h-32"></div>
                <div class="bg-white rounded-xl p-6 h-32"></div>
                <div class="bg-white rounded-xl p-6 h-32"></div>
            </div>
        </div>

        <!-- Message vide -->
        <div id="emptyMessage" class="hidden bg-white rounded-xl p-12 text-center">
            <div class="text-6xl mb-4">ðŸ“š</div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun chapitre disponible</h3>
            <p class="text-gray-600">Les chapitres seront ajoutÃ©s bientÃ´t par les enseignants.</p>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://zbbulpomopfwkqipbehk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiYnVscG9tb3Bmd2txaXBiZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDM3NDksImV4cCI6MjA3ODk3OTc0OX0.Heak4t8B6vtUIX0SxlOW7W75cn1KD5UYe0lkoO1kW7A'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        let matiereId = null
        let currentUser = null

        async function init() {
            // VÃ©rifier authentification
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) {
                window.location.href = 'login.html'
                return
            }
            currentUser = user

            // RÃ©cupÃ©rer l'ID de la matiÃ¨re depuis l'URL
            const urlParams = new URLSearchParams(window.location.search)
            matiereId = urlParams.get('id')
            const matiereNom = urlParams.get('nom')

            if (!matiereId) {
                window.location.href = 'dashboard-eleve.html'
                return
            }

            // Charger les donnÃ©es
            await loadMatiere()
            await loadClasses()
            await loadChapitres()

            // Ã‰couter le changement de filtre
            document.getElementById('classeFilter').addEventListener('change', loadChapitres)
        }

        async function loadMatiere() {
            try {
                const { data: matiere } = await supabase
                    .from('matieres')
                    .select('*')
                    .eq('id', matiereId)
                    .single()

                if (matiere) {
                    document.getElementById('matiereTitle').textContent = matiere.nom
                    document.getElementById('matiereIcon').textContent = matiere.icone_url || 'ðŸ“š'
                    document.title = `${matiere.nom} - LearnHub`
                }
            } catch (error) {
                console.error('Erreur chargement matiÃ¨re:', error)
            }
        }

        async function loadClasses() {
            try {
                const { data: classes } = await supabase
                    .from('classes')
                    .select('*')
                    .order('ordre')

                const select = document.getElementById('classeFilter')
                if (classes && classes.length > 0) {
                    classes.forEach(classe => {
                        const option = document.createElement('option')
                        option.value = classe.id
                        option.textContent = classe.nom
                        select.appendChild(option)
                    })
                }
            } catch (error) {
                console.error('Erreur chargement classes:', error)
            }
        }

        async function loadChapitres() {
            try {
                const classeId = document.getElementById('classeFilter').value
                
                let query = supabase
                    .from('chapitres')
                    .select(`
                        *,
                        classes:classes(nom),
                        cours:cours(count)
                    `)
                    .eq('matiere_id', matiereId)
                    .eq('est_publie', true)
                    .order('ordre')

                if (classeId) {
                    query = query.eq('classe_id', classeId)
                }

                const { data: chapitres, error } = await query

                if (error) throw error

                const container = document.getElementById('chapitresContainer')
                const emptyMessage = document.getElementById('emptyMessage')

                if (!chapitres || chapitres.length === 0) {
                    container.classList.add('hidden')
                    emptyMessage.classList.remove('hidden')
                    return
                }

                container.classList.remove('hidden')
                emptyMessage.classList.add('hidden')

                // RÃ©cupÃ©rer les progressions de l'utilisateur
                const { data: progressions } = await supabase
                    .from('progressions_cours')
                    .select('cours_id, progression_pourcentage, est_termine')
                    .eq('user_id', currentUser.id)

                const progressMap = {}
                progressions?.forEach(p => {
                    progressMap[p.cours_id] = p
                })

                container.innerHTML = chapitres.map((chapitre, index) => {
                    const coursCount = chapitre.cours[0]?.count || 0
                    const difficulteColors = {
                        'facile': 'bg-green-100 text-green-700',
                        'moyen': 'bg-yellow-100 text-yellow-700',
                        'difficile': 'bg-red-100 text-red-700'
                    }
                    const difficulteClass = difficulteColors[chapitre.difficulte] || 'bg-gray-100 text-gray-700'

                    // Calculer la progression totale du chapitre
                    let progression = 0
                    if (coursCount > 0) {
                        // Ã€ amÃ©liorer : calculer la vraie progression
                        progression = 0
                    }

                    return `
                        <div onclick="openChapitre(${chapitre.id})" 
                             class="bg-white rounded-xl p-6 shadow-sm border-2 border-gray-100 hover:shadow-md hover:border-blue-200 transition cursor-pointer">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full">
                                            Chapitre ${index + 1}
                                        </span>
                                        ${chapitre.difficulte ? `
                                            <span class="px-3 py-1 ${difficulteClass} text-xs font-semibold rounded-full">
                                                ${chapitre.difficulte}
                                            </span>
                                        ` : ''}
                                        ${chapitre.classes ? `
                                            <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">
                                                ${chapitre.classes.nom}
                                            </span>
                                        ` : ''}
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-900 mb-2">${chapitre.titre}</h3>
                                    <p class="text-sm text-gray-600 mb-3">${chapitre.description || 'Aucune description disponible'}</p>
                                    
                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                                            </svg>
                                            ${coursCount} cours
                                        </span>
                                        ${chapitre.duree_estimee ? `
                                            <span class="flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                                </svg>
                                                ${chapitre.duree_estimee} min
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>

                            ${progression > 0 ? `
                                <div class="mt-4">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Progression</span>
                                        <span class="font-semibold">${progression}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full" style="width: ${progression}%"></div>
                                    </div>
                                </div>
                            ` : ''}

                            ${chapitre.pdf_url ? `
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <a href="${chapitre.pdf_url}" target="_blank" 
                                       onclick="event.stopPropagation()"
                                       class="inline-flex items-center text-sm text-blue-600 hover:text-blue-700 font-semibold">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        TÃ©lÃ©charger le PDF
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `
                }).join('')
            } catch (error) {
                console.error('Erreur chargement chapitres:', error)
                document.getElementById('chapitresContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                        <p class="text-red-700">Erreur lors du chargement des chapitres</p>
                    </div>
                `
            }
        }

        window.openChapitre = function(chapitreId) {
            window.location.href = `chapitre.html?id=${chapitreId}`
        }

        init()
    </script>
</body>
</html>