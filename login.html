<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - LearnHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            
            <!-- Logo & Title -->
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl shadow-lg mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-900">Connexion</h2>
                <p class="mt-2 text-sm text-gray-600">Bienvenue sur LearnHub</p>
            </div>

            <!-- Message d'erreur/succÃ¨s -->
            <div id="messageContainer" class="hidden rounded-lg p-4"></div>

            <!-- Formulaire -->
            <form id="loginForm" class="mt-8 space-y-6 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                        <input 
                            id="email" 
                            name="email" 
                            type="email" 
                            required 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition"
                            placeholder="votre.email@exemple.com">
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Mot de passe</label>
                        <input 
                            id="password" 
                            name="password" 
                            type="password" 
                            required 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition"
                            placeholder="••••••••">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember" type="checkbox" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <label for="remember" class="ml-2 text-sm text-gray-600">Se souvenir de moi</label>
                    </div>
                    <a href="#" class="text-sm text-purple-600 hover:text-purple-700 font-semibold">Mot de passe oublié ?</a>
                </div>

                <button 
                    type="submit" 
                    id="loginBtn"
                    class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                    Se connecter
                </button>

                <div class="text-center">
                    <p class="text-sm text-gray-600">
                        Pas encore de compte ? 
                        <a href="register.html" class="text-purple-600 hover:text-purple-700 font-semibold">S'inscrire</a>
                    </p>
                </div>
            </form>

            <!-- Retour accueil -->
            <div class="text-center">
                <a href="index.html" class="text-gray-600 hover:text-gray-900 font-medium">Retour à l'accueil</a>
            </div>
        </div>
    </div>

    <script type="module">
        // Configuration Supabase
        const SUPABASE_URL = 'https://zbbulpomopfwkqipbehk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiYnVscG9tb3Bmd2txaXBiZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDM3NDksImV4cCI6MjA3ODk3OTc0OX0.Heak4t8B6vtUIX0SxlOW7W75cn1KD5UYe0lkoO1kW7A'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // VÃ©rifier si dÃ©jÃ  connectÃ©
        async function checkExistingSession() {
            const { data: { user } } = await supabase.auth.getUser()
            
            if (user) {
                console.log(' Utilisateur déja  connecté, redirection...')
                await redirectToDashboard(user.id)
            }
        }

        // Fonction de redirection intelligente
        async function redirectToDashboard(userId) {
            try {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('type_parcours, nom')
                    .eq('id', userId)
                    .single()

                if (!profile) {
                    showMessage('Profil introuvable. Veuillez vous réinscrire.', 'error')
                    await supabase.auth.signOut()
                    return
                }

                console.log('type de Profil:', profile.type_parcours)

                // Redirection selon le type de parcours
                switch(profile.type_parcours) {
                    case 'eleve':
                        window.location.href = 'dashboard-eleve.html'
                        break
                    case 'dev-web':
                        window.location.href = 'dashboard-dev.html'
                        break
                    case 'designer':
                        window.location.href = 'dashboard-designer.html'
                        break
                    default:
                        showMessage('Type de parcours inconnu', 'error')
                }
            } catch (error) {
                console.error('Erreur redirection:', error)
                showMessage('Erreur lors de la redirection', 'error')
            }
        }

        // Afficher un message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer')
            container.className = `rounded-lg p-4 ${
                type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
                type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' :
                'bg-blue-100 text-blue-700 border border-blue-200'
            }`
            container.textContent = message
            container.classList.remove('hidden')
            
            if (type === 'success') {
                setTimeout(() => container.classList.add('hidden'), 3000)
            }
        }

        // GÃ©rer la connexion
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const email = document.getElementById('email').value.trim()
            const password = document.getElementById('password').value
            const btn = document.getElementById('loginBtn')
            
            // Validation
            if (!email || !password) {
                showMessage('Veuillez remplir tous les champs', 'error')
                return
            }

            btn.disabled = true
            btn.textContent = 'Connexion en cours...'

            try {
                console.log('ðŸ” Tentative de connexion:', email)

                // Connexion Supabase
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                if (error) throw error

                console.log('âœ… Connexion rÃ©ussie!')
                showMessage('Connexion rÃ©ussie ! Redirection...', 'success')

                // Redirection aprÃ¨s 1 seconde
                setTimeout(() => {
                    redirectToDashboard(data.user.id)
                }, 1000)

            } catch (error) {
                console.error('âŒ Erreur:', error)
                
                let errorMessage = 'Erreur de connexion'
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Email ou mot de passe incorrect'
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'Veuillez confirmer votre email'
                } else {
                    errorMessage = error.message
                }
                
                showMessage(errorMessage, 'error')
                btn.disabled = false
                btn.textContent = 'Se connecter'
            }
        })

        // VÃ©rifier session au chargement
        checkExistingSession()
    </script>
</body>
</html>