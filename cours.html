<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cours - LearnHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .cours-content {
            line-height: 1.8;
        }
        .cours-content h1 { @apply text-3xl font-bold text-gray-900 mb-4 mt-8; }
        .cours-content h2 { @apply text-2xl font-bold text-gray-900 mb-3 mt-6; }
        .cours-content h3 { @apply text-xl font-bold text-gray-900 mb-2 mt-4; }
        .cours-content p { @apply text-gray-700 mb-4; }
        .cours-content ul, .cours-content ol { @apply ml-6 mb-4 space-y-2; }
        .cours-content li { @apply text-gray-700; }
        .cours-content code { @apply bg-gray-100 px-2 py-1 rounded text-sm font-mono; }
        .cours-content pre { @apply bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto mb-4; }
        .cours-content blockquote { @apply border-l-4 border-blue-500 pl-4 italic text-gray-600 my-4; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar fixe -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed top-0 w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="history.back()" class="text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <div>
                        <h1 id="coursTitle" class="text-lg font-bold text-gray-900">Chargement...</h1>
                        <p id="coursMeta" class="text-xs text-gray-500"></p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="markCompleteBtn" onclick="markAsComplete()" 
                            class="hidden px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                        ‚úì Marquer comme termin√©
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-20 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Video Player (si vid√©o) -->
        <div id="videoContainer" class="hidden mb-8">
            <div class="bg-black rounded-xl overflow-hidden shadow-2xl">
                <iframe id="videoPlayer" 
                        class="w-full aspect-video" 
                        frameborder="0" 
                        allowfullscreen></iframe>
            </div>
        </div>

        <!-- Contenu du cours -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
            <div id="coursContent" class="cours-content">
                <!-- Chargement dynamique -->
                <div class="animate-pulse space-y-4">
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-4 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    <div class="h-4 bg-gray-200 rounded w-4/6"></div>
                </div>
            </div>
        </div>

        <!-- Ressources -->
        <div id="ressourcesSection" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-4">üìé Ressources t√©l√©chargeables</h3>
            <div id="ressourcesContainer" class="space-y-2">
                <!-- Chargement dynamique -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex items-center justify-between bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <button id="prevBtn" onclick="navigateCours('prev')" 
                    class="hidden px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">
                ‚Üê Cours pr√©c√©dent
            </button>
            <div class="flex-1"></div>
            <button id="nextBtn" onclick="navigateCours('next')" 
                    class="hidden px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                Cours suivant ‚Üí
            </button>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://zbbulpomopfwkqipbehk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiYnVscG9tb3Bmd2txaXBiZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDM3NDksImV4cCI6MjA3ODk3OTc0OX0.Heak4t8B6vtUIX0SxlOW7W75cn1KD5UYe0lkoO1kW7A'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        let coursId = null
        let currentUser = null
        let currentCours = null
        let allCours = []

        async function init() {
            // V√©rifier authentification
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) {
                window.location.href = 'login.html'
                return
            }
            currentUser = user

            // R√©cup√©rer l'ID du cours
            const urlParams = new URLSearchParams(window.location.search)
            coursId = urlParams.get('id')

            if (!coursId) {
                history.back()
                return
            }

            await loadCours()
            await loadRessources()
            await trackProgress()
            await loadNavigation()
        }

        async function loadCours() {
            try {
                const { data: cours, error } = await supabase
                    .from('cours')
                    .select(`
                        *,
                        chapitres:chapitres(
                            titre,
                            matieres:matieres(nom, icone_url)
                        )
                    `)
                    .eq('id', coursId)
                    .single()

                if (error) throw error
                currentCours = cours

                // Mettre √† jour l'interface
                document.getElementById('coursTitle').textContent = cours.titre
                document.getElementById('coursMeta').textContent = 
                    `${cours.chapitres.matieres.nom} ‚Ä¢ ${cours.chapitres.titre}`
                document.title = `${cours.titre} - LearnHub`

                // Afficher la vid√©o si c'est un cours vid√©o
                if (cours.type_contenu === 'video' && cours.video_url) {
                    const videoContainer = document.getElementById('videoContainer')
                    
                    videoContainer.classList.remove('hidden')
                    displayVideo(cours.video_url, videoContainer)
                }

                // Afficher le contenu
                document.getElementById('coursContent').innerHTML = cours.contenu

                // V√©rifier si d√©j√† termin√©
                const { data: progression } = await supabase
                    .from('progressions_cours')
                    .select('est_termine')
                    .eq('user_id', currentUser.id)
                    .eq('cours_id', coursId)
                    .single()

                if (!progression?.est_termine) {
                    document.getElementById('markCompleteBtn').classList.remove('hidden')
                }

                // Incr√©menter le nombre de vues
                await supabase
                    .from('cours')
                    .update({ vues_total: (cours.vues_total || 0) + 1 })
                    .eq('id', coursId)

            } catch (error) {
                console.error('Erreur chargement cours:', error)
                document.getElementById('coursContent').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-xl font-bold mb-2">Erreur de chargement</p>
                        <p>Impossible de charger ce cours.</p>
                    </div>
                `
            }
        }

        function displayVideo(url, container) {
            // D√©terminer le type de vid√©o
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                // YouTube
                const videoPlayer = document.getElementById('videoPlayer')
                videoPlayer.src = getEmbedUrl(url)
            } else if (url.includes('vimeo.com')) {
                // Vimeo
                const videoId = url.split('/').pop()
                const videoPlayer = document.getElementById('videoPlayer')
                videoPlayer.src = `https://player.vimeo.com/video/${videoId}`
            } else if (url.includes('dailymotion.com')) {
                // Dailymotion
                const videoId = url.split('/').pop().split('_')[0]
                const videoPlayer = document.getElementById('videoPlayer')
                videoPlayer.src = `https://www.dailymotion.com/embed/video/${videoId}`
            } else {
                // Vid√©o locale ou autre - utiliser HTML5 video
                container.innerHTML = `
                    <video id="localVideo" class="w-full rounded-xl" controls controlsList="nodownload">
                        <source src="${url}" type="video/mp4">
                        <source src="${url}" type="video/webm">
                        <source src="${url}" type="video/ogg">
                        Votre navigateur ne supporte pas la lecture de vid√©os.
                    </video>
                `
                
                // G√©rer les erreurs de chargement
                const video = document.getElementById('localVideo')
                video.addEventListener('error', function(e) {
                    console.error('Erreur chargement vid√©o:', e)
                    container.innerHTML = `
                        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-8 text-center">
                            <div class="text-6xl mb-4">üé•</div>
                            <h3 class="text-xl font-bold text-red-700 mb-2">Erreur de chargement</h3>
                            <p class="text-red-600 mb-4">La vid√©o ne peut pas √™tre charg√©e. Le fichier n'existe peut-√™tre pas ou le chemin est incorrect.</p>
                            <p class="text-sm text-gray-600 font-mono bg-red-100 p-2 rounded">${url}</p>
                            <div class="mt-4 text-left bg-white p-4 rounded-lg">
                                <h4 class="font-bold text-gray-900 mb-2">üí° Solutions :</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    <li>‚Ä¢ V√©rifiez que la vid√©o est upload√©e sur le serveur</li>
                                    <li>‚Ä¢ Utilisez un lien YouTube/Vimeo √† la place</li>
                                    <li>‚Ä¢ V√©rifiez le chemin du fichier dans la base de donn√©es</li>
                                    <li>‚Ä¢ Assurez-vous que le fichier est accessible publiquement</li>
                                </ul>
                            </div>
                        </div>
                    `
                })
            }
        }

        function getEmbedUrl(url) {
            // Convertir les URLs YouTube en format embed
            if (url.includes('youtube.com/watch')) {
                const videoId = new URL(url).searchParams.get('v')
                return `https://www.youtube.com/embed/${videoId}`
            }
            if (url.includes('youtu.be/')) {
                const videoId = url.split('youtu.be/')[1].split('?')[0]
                return `https://www.youtube.com/embed/${videoId}`
            }
            return url
        }

        async function loadRessources() {
            try {
                const { data: ressources } = await supabase
                    .from('ressources')
                    .select('*')
                    .eq('cours_id', coursId)

                if (!ressources || ressources.length === 0) return

                document.getElementById('ressourcesSection').classList.remove('hidden')

                document.getElementById('ressourcesContainer').innerHTML = ressources.map(r => {
                    const typeIcons = {
                        'pdf': 'üìÑ',
                        'zip': 'üì¶',
                        'doc': 'üìù',
                        'image': 'üñºÔ∏è'
                    }
                    const icon = typeIcons[r.type_fichier] || 'üìé'
                    const taille = r.taille_fichier ? `${(r.taille_fichier / 1024 / 1024).toFixed(2)} MB` : ''

                    return `
                        <a href="${r.url_fichier}" download target="_blank"
                           class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${r.titre}</h4>
                                    <p class="text-xs text-gray-500">${taille} ‚Ä¢ ${r.nombre_telechargements || 0} t√©l√©chargements</p>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </a>
                    `
                }).join('')
            } catch (error) {
                console.error('Erreur chargement ressources:', error)
            }
        }

        async function trackProgress() {
            try {
                // Cr√©er ou mettre √† jour la progression
                const { data: existing } = await supabase
                    .from('progressions_cours')
                    .select('id, temps_passe')
                    .eq('user_id', currentUser.id)
                    .eq('cours_id', coursId)
                    .single()

                if (!existing) {
                    await supabase
                        .from('progressions_cours')
                        .insert({
                            user_id: currentUser.id,
                            cours_id: coursId,
                            progression_pourcentage: 10,
                            date_debut: new Date().toISOString()
                        })
                }

                // Tracker le temps pass√© (optionnel)
                const startTime = Date.now()
                window.addEventListener('beforeunload', async () => {
                    const tempsEcoule = Math.floor((Date.now() - startTime) / 1000)
                    await supabase
                        .from('progressions_cours')
                        .update({
                            temps_passe: (existing?.temps_passe || 0) + tempsEcoule
                        })
                        .eq('user_id', currentUser.id)
                        .eq('cours_id', coursId)
                })
            } catch (error) {
                console.error('Erreur tracking progression:', error)
            }
        }

        async function loadNavigation() {
            try {
                // Charger tous les cours du chapitre
                const { data: cours } = await supabase
                    .from('cours')
                    .select('id, titre, ordre')
                    .eq('chapitre_id', currentCours.chapitre_id)
                    .eq('est_publie', true)
                    .order('ordre')

                allCours = cours || []
                const currentIndex = allCours.findIndex(c => c.id === parseInt(coursId))

                // Afficher les boutons de navigation
                if (currentIndex > 0) {
                    document.getElementById('prevBtn').classList.remove('hidden')
                }
                if (currentIndex < allCours.length - 1) {
                    document.getElementById('nextBtn').classList.remove('hidden')
                }
            } catch (error) {
                console.error('Erreur navigation:', error)
            }
        }

        window.markAsComplete = async function() {
            try {
                const btn = document.getElementById('markCompleteBtn')
                btn.disabled = true
                btn.textContent = '‚è≥ Enregistrement...'

                await supabase
                    .from('progressions_cours')
                    .update({
                        est_termine: true,
                        progression_pourcentage: 100,
                        date_fin: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('cours_id', coursId)

                // Ajouter les points
                await supabase
                    .from('profiles')
                    .update({
                        points_total: supabase.raw(`points_total + ${currentCours.points_recompense || 10}`)
                    })
                    .eq('id', currentUser.id)

                btn.textContent = '‚úì Termin√© !'
                btn.classList.remove('bg-green-600', 'hover:bg-green-700')
                btn.classList.add('bg-gray-400')

                // Afficher une notification
                alert(`üéâ Bravo ! Vous avez gagn√© ${currentCours.points_recompense || 10} points !`)

                // Passer au cours suivant automatiquement
                setTimeout(() => {
                    navigateCours('next')
                }, 2000)
            } catch (error) {
                console.error('Erreur marquage termin√©:', error)
                alert('Erreur lors de l\'enregistrement')
            }
        }

        window.navigateCours = function(direction) {
            const currentIndex = allCours.findIndex(c => c.id === parseInt(coursId))
            let nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1

            if (nextIndex >= 0 && nextIndex < allCours.length) {
                window.location.href = `cours.html?id=${allCours[nextIndex].id}`
            }
        }

        init()
    </script>
</body>
</html>